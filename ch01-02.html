<!DOCTYPE HTML>
<html lang="cn" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>运行 Starry 的测例 - Starry Tutorial Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Starry Tutorial Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rcore-os/arceos-tutorial-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="运行-starry-的测例"><a class="header" href="#运行-starry-的测例">运行 Starry 的测例</a></h1>
<p>本章我们将介绍如何在 Starry 上运行现有的测例，从而完成本地测试。</p>
<h2 id="准备基座仓库"><a class="header" href="#准备基座仓库">准备基座仓库</a></h2>
<p>Starry 本身是基于 <a href="https://github.com/arceos-org/arceos">ArceOS</a> 开发的，利用异构组件化内核的思想在 Unikernel 上层添加实现宏内核扩展。因此我们需要先 clone 基座仓库到本地。</p>
<pre><code class="language-shell"># Clone the base repository
./scripts/get_deps.sh
</code></pre>
<h2 id="运行指令"><a class="header" href="#运行指令">运行指令</a></h2>
<p>我们先跑起来一个最简单的测试用例，并查看输出结果。</p>
<p>我们使用 <a href="https://github.com/equation314/nimbos">nimbos</a> 所使用到的<a href="https://github.com/equation314/nimbos/tree/main/user">测例</a> 为例。这一测例由于重新编写了使用的依赖库，因此需要用到的 syscall 会较少，适合为初级形态的内核进行测试。</p>
<p>运行指令为：</p>
<pre><code class="language-shell"># Build user applications
make user_apps ARCH=x86_64

# Build kernel
make ARCH=x86_64 LOG=off build

# Run kernel
make ARCH=x86_64 LOG=off run
</code></pre>
<p>期望输出为：</p>
<pre><code class="language-shell">smp = 1
build_mode = release
log_level = off

Hello world from user mode program!
Hello, world!
Hello, I am process 2.
Back in process 2, iteration 0.
Back in process 2, iteration 1.
Back in process 2, iteration 2.
Back in process 2, iteration 3.
Back in process 2, iteration 4.
yield passed!
into sleep test!
simple_sleep passed!
</code></pre>
<h2 id="测例执行逻辑"><a class="header" href="#测例执行逻辑">测例执行逻辑</a></h2>
<p>目前 Starry 主线未支持从文件镜像中读取已经编译好的二进制测例，相关的测例存储在 <code>apps/</code> 目录下。目前可以看到测例目录包括 <code>nimbos</code> 和 <code>libc</code>，分别代表 nimbos 的测例和 libc(musl) 的测例。</p>
<p>我们可以利用环境变量 <code>AX_TESTCASE</code> 指定需要编译的测例，例如：</p>
<pre><code class="language-shell">make user_apps ARCH=x86_64 AX_TESTCASE=libc
</code></pre>
<p>即可编译 <code>libc</code> 测例为 x86_64 架构的二进制可执行文件。</p>
<p>之后我们在 <code>build.rs</code> 读取所有的可执行文件，并按序排列之后形成 <code>link_app.S</code>。在 <code>src/loader.rs</code> 下我们调用 <code>global_asm</code> 语句将测例的二进制文件直接和内核打包在一起，从而让内核能够直接通过 ramfs 读取、运行测例。</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>global_asm!(include_str!(concat!(env!("OUT_DIR"), "/link_app.S")));
<span class="boring">}</span></code></pre></pre>
<p>这一步操作非常类似 rCore-Tutorial 的 <a href="https://rcore-os.cn/rCore-Tutorial-Book-v3/chapter3/1multi-loader.html">多道程序与分时多任务</a>，可以进行借鉴。</p>
<p>之后在 <code>src/main.rs</code> 中我们会读取环境变量中指定的 <code>AX_TESTCASES_LIST</code> 变量(由 Makefile 生成)，从而了解目前要运行的所有测例内容，从而逐个读取测例完成测试。</p>
<h2 id="利用文件镜像读取测例"><a class="header" href="#利用文件镜像读取测例">利用文件镜像读取测例</a></h2>
<p>将测例打包为 ramfs 并不是长久之策，只是开发过程的一个过渡。将测例文件打包为镜像进行读取的实现可以参考<a href="https://github.com/xingmin1/Starry-On-ArceOS/commit/e34716404ba4a75e22a8853ce476b7919dece120">这里</a>。</p>
<p>当将这一修改合入主线之后，我们会更新本文档。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ch01-01.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="ch01-03.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ch01-01.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="ch01-03.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>

        <script src="ace.js"></script>
        <script src="editor.js"></script>
        <script src="mode-rust.js"></script>
        <script src="theme-dawn.js"></script>
        <script src="theme-tomorrow_night.js"></script>

        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>


    </div>
    </body>
</html>
